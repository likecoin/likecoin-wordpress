(()=>{const t="LikeCoin WordPress Plugin",e=document.querySelector("#lcTitleStatus"),n=document.querySelector("#lcISCNStatus");function o(t,{text:e,className:n,id:o,rel:i,target:s,href:a}){const c=document.createElement(t);return e&&(c.innerText=e),o&&c.setAttribute("id",o),n&&c.setAttribute("class",n),i&&c.setAttribute("rel",i),s&&c.setAttribute("target",s),a&&c.setAttribute("href",a),c}const{mainStatusLoading:i,mainStatusFailedPopUp:s,mainStatusLIKEPay:a,mainStatusUploadArweave:c,mainStatusRegisterISCN:r,buttonSubmitISCN:l,buttonRegisterISCN:d,buttonUpdateISCN:u,draft:p}=lcStringInfo,S={loading:i,failedPopup:s,onLIKEPay:a,onUploadArweave:c,onRegisterISCN:r},f=`https://app.${window.likecoinApiSettings.likecoHost}`;function I(t,n){e.textContent="";const i=o("h1",{text:" Â· ",className:t}),s=o("h3",{text:n,className:"iscn-status-text"});e.appendChild(i),e.appendChild(s)}function m(t){return S[t]?S[t]:"-"}function g(t,e){t&&(t.textContent="",t.appendChild(e))}function h(t,e){g(t,o("p",{text:e}))}async function P(t){t&&t.preventDefault();const e=document.querySelector("#lcArweaveStatus"),i=document.querySelector("#lcIPFSStatus"),{iscnHash:s,iscnId:a,lastModifiedTime:c,iscnTimestamp:r=0}=lcPostInfo,p=await jQuery.ajax({type:"POST",url:`${likecoinApiSettings.root}likecoin/v1/posts/${likecoinApiSettings.postId}/iscn/refresh`,method:"POST",beforeSend:t=>{t.setRequestHeader("X-WP-Nonce",likecoinApiSettings.nonce)}}),{ipfs:S,arweave:f}=p,P=p.wordpress_published;if(s&&a){const t=encodeURIComponent(a);I("iscn-status-green",lcStringInfo.mainTitleDone);const e=o("a",{text:a,rel:"noopener",target:"_blank",href:`https://app.${window.likecoinApiSettings.likecoHost}/view/${t}`});g(n,e)}if("publish"!==P||"initial"!==lcPostInfo.mainStatus&&!lcPostInfo.mainStatus.includes("failed")||a&&!(c>r))if("publish"!==P){I("iscn-status-red",lcStringInfo.mainTitleDraft);const t=o("button",{text:l,className:"button button-primary",id:"lcArweaveUploadBtn"});t.disabled="disabled";const e=o("p",{text:lcStringInfo.mainTitleDraft}),i=document.createElement("div");i.appendChild(t),i.appendChild(e),g(n,i)}else I("iscn-status-orange",lcStringInfo.mainTitleIntermediate),h(n,m(lcPostInfo.mainStatus));else{I("iscn-status-orange",lcStringInfo.mainTitleIntermediate);let t=f.url?d:l;a&&(t=u);const e=o("button",{text:t,className:"button button-primary",id:"lcArweaveUploadBtn"});g(n,e),e.addEventListener("click",y)}if(f.url){const{url:t}=f;g(e,o("a",{text:f.arweave_id,rel:"noopener",target:"_blank",href:t}))}if(S.url){const{url:t,hash:e}=S;g(i,o("a",{text:e,rel:"noopener",target:"_blank",href:t}))}}async function w(e){if(e.origin===f)try{const{action:o,data:i}=JSON.parse(e.data);"ISCN_WIDGET_READY"===o?async function(){const{ISCNWindow:e}=lcPostInfo;if(!e)throw new Error("POPUP_WINDOW_NOT_FOUND");e.postMessage(JSON.stringify({action:"INIT_WIDGET"}),f);try{const n=await jQuery.ajax({type:"GET",url:`${likecoinApiSettings.root}likecoin/v1/posts/${likecoinApiSettings.postId}/iscn/arweave/upload`,dataType:"json",method:"GET",beforeSend:t=>{t.setRequestHeader("X-WP-Nonce",likecoinApiSettings.nonce)}}),{files:o,title:i,tags:s,url:a,author:c,authorDescription:r,description:l}=n,d=[];e.postMessage(JSON.stringify({action:"SUBMIT_ISCN_DATA",data:{files:o,metadata:{name:i,tags:s,url:a,author:c,authorDescription:r,description:l,fingerprints:d,type:"article",license:"",recordNotes:t,memo:t}}}),f)}catch(t){console.error("error occured when submitting ISCN:"),console.error(t),lcPostInfo.mainStatus="failed"}}():"ARWEAVE_SUBMITTED"===o?async function(t){const{ipfsHash:e,arweaveId:o}=t;if(e&&o){lcPostInfo.arweaveIPFSHash=e,lcPostInfo.arweaveId=o,h(n,m(lcPostInfo.mainStatus));const t={arweaveIPFSHash:e,arweaveId:o};try{await jQuery.ajax({type:"POST",url:`${likecoinApiSettings.root}likecoin/v1/posts/${likecoinApiSettings.postId}/iscn/arweave`,dataType:"json",contentType:"application/json; charset=UTF-8",data:JSON.stringify(t),method:"POST",beforeSend:t=>{t.setRequestHeader("X-WP-Nonce",likecoinApiSettings.nonce)}})}catch(t){console.error(t)}finally{await P()}}}(i):"ISCN_SUBMITTED"===o?async function(t){lcPostInfo.mainStatus="onRegisterISCN";try{const{tx_hash:e,error:n,success:o,iscnId:i}=t;if(n||!1===o)throw new Error("REGISTER_ISCN_SERVER_ERROR");await jQuery.ajax({type:"POST",url:`${likecoinApiSettings.root}likecoin/v1/posts/${likecoinApiSettings.postId}/iscn/metadata`,dataType:"json",contentType:"application/json; charset=UTF-8",data:JSON.stringify({iscnHash:e,iscnId:i}),method:"POST",beforeSend:t=>{t.setRequestHeader("X-WP-Nonce",likecoinApiSettings.nonce)}}),lcPostInfo.iscnHash=e,lcPostInfo.iscnId=i,lcPostInfo.mainStatus="done"}catch(t){console.error(t),lcPostInfo.mainStatus="failed"}finally{await P()}}(i):console.warn(`Unknown event: ${o}`)}catch(t){console.error(t)}}async function y(t){t&&t.preventDefault();const{siteurl:e}=likecoinApiSettings,{url:o}=lcPostInfo;lcPostInfo.mainStatus="onRegisterISCN",h(n,m(lcPostInfo.mainStatus));const i=encodeURIComponent(e),s=encodeURIComponent(lcPostInfo.iscnId||""),a=encodeURIComponent(o),c=`${f}/nft/url?opener=1&platform=wordpress&redirect_uri=${i}&url=${a}&iscn_id=${s}&update=${s?1:0}`,r=window.open(c,"likeCoISCNWindow","menubar=no,location=no,width=576,height=768");if(!r||r.closed||void 0===r.closed)return lcPostInfo.mainStatus="failedPopup",void h(n,m(lcPostInfo.mainStatus));lcPostInfo.ISCNWindow=r,lcPostInfo.mainStatus="initial",window.addEventListener("message",w,!1)}(()=>{const t=document.getElementById("lcPublishRefreshBtn");t&&t.addEventListener("click",P),P()})()})();