!function(){const t="LikeCoin WordPress Plugin",e=document.querySelector("#lcTitleStatus"),n=document.querySelector("#lcISCNStatus");function o(t,e){let{text:n,className:o,id:i,rel:s,target:a,href:r}=e;const c=document.createElement(t);return n&&(c.innerText=n),i&&c.setAttribute("id",i),o&&c.setAttribute("class",o),s&&c.setAttribute("rel",s),a&&c.setAttribute("target",a),r&&c.setAttribute("href",r),c}const{mainStatusLoading:i,mainStatusFailedPopUp:s,mainStatusLIKEPay:a,mainStatusUploadArweave:r,mainStatusRegisterISCN:c,buttonSubmitISCN:l,buttonRegisterISCN:d,buttonUpdateISCN:u,draft:p}=lcStringInfo,f={loading:i,failedPopup:s,onLIKEPay:a,onUploadArweave:r,onRegisterISCN:c},S=`https://app.${window.likecoinApiSettings.likecoHost}`;function I(t,n){e.textContent="";const i=o("h1",{text:" Â· ",className:t}),s=o("h3",{text:n,className:"iscn-status-text"});e.appendChild(i),e.appendChild(s)}function m(t){return f[t]?f[t]:"-"}function h(t,e){t&&(t.textContent="",t.appendChild(e))}function g(t,e){h(t,o("p",{text:e}))}async function P(t){t&&t.preventDefault();const e=document.querySelector("#lcMattersStatus"),i=document.querySelector("#lcArweaveStatus"),s=document.querySelector("#lcIPFSStatus"),{iscnHash:a,iscnId:r,isMattersPublished:c,lastModifiedTime:f,iscnTimestamp:S}=lcPostInfo,P=await jQuery.ajax({type:"POST",url:`${likecoinApiSettings.root}likecoin/v1/posts/${likecoinApiSettings.postId}/iscn/refresh`,method:"POST",beforeSend:t=>{t.setRequestHeader("X-WP-Nonce",likecoinApiSettings.nonce)}}),{matters:w,ipfs:b,arweave:N}=P,T=P.wordpress_published;if(lcPostInfo.isMattersPublished=P.matters.status,lcPostInfo.mattersIPFSHash=P.matters.ipfs_hash,a&&r){const t=encodeURIComponent(r);I("iscn-status-green",lcStringInfo.mainTitleDone);const e=o("a",{text:r,rel:"noopener",target:"_blank",href:`https://app.${window.likecoinApiSettings.likecoHost}/view/${t}`});h(n,e)}if("publish"!==T||"initial"!==lcPostInfo.mainStatus&&!lcPostInfo.mainStatus.includes("failed")||r&&!(f>S))if("publish"!==T){I("iscn-status-red",lcStringInfo.mainTitleDraft);const t=o("button",{text:l,className:"button button-primary",id:"lcArweaveUploadBtn"});t.disabled="disabled";const e=o("p",{text:lcStringInfo.mainTitleDraft}),i=document.createElement("div");i.appendChild(t),i.appendChild(e),h(n,i)}else I("iscn-status-orange",lcStringInfo.mainTitleIntermediate),g(n,m(lcPostInfo.mainStatus));else{I("iscn-status-orange",lcStringInfo.mainTitleIntermediate);let t=N.url?d:l;r&&(t=u);const e=o("button",{text:t,className:"button button-primary",id:"lcArweaveUploadBtn"});h(n,e),e.addEventListener("click",y)}if(N.url){const{url:t}=N;h(i,o("a",{text:N.arweave_id,rel:"noopener",target:"_blank",href:t}))}if(b.url){const{url:t,hash:e}=b;h(s,o("a",{text:e,rel:"noopener",target:"_blank",href:t}))}if(w.url){const{url:t}=w,n=w.article_id;let i;i="Published"===c?o("a",{text:n,rel:"noopener",target:"_blank",href:t}):0!==n.length?o("a",{text:p,rel:"noopener",target:"_blank",href:t}):o("p",{text:"-"}),h(e,i)}}async function w(e){if(e.origin===S)try{const{action:o,data:i}=JSON.parse(e.data);"ISCN_WIDGET_READY"===o?async function(){const{ISCNWindow:e}=lcPostInfo;if(!e)throw new Error("POPUP_WINDOW_NOT_FOUND");e.postMessage(JSON.stringify({action:"INIT_WIDGET"}),S);try{const n=await jQuery.ajax({type:"GET",url:`${likecoinApiSettings.root}likecoin/v1/posts/${likecoinApiSettings.postId}/iscn/arweave/upload`,dataType:"json",method:"GET",beforeSend:t=>{t.setRequestHeader("X-WP-Nonce",likecoinApiSettings.nonce)}}),{files:o,title:i,tags:s,url:a,author:r,authorDescription:c,description:l,mattersIPFSHash:d}=n,u=[];if(d){const t=`ipfs://${d}`;u.push(t)}e.postMessage(JSON.stringify({action:"SUBMIT_ISCN_DATA",data:{files:o,metadata:{name:i,tags:s,url:a,author:r,authorDescription:c,description:l,fingerprints:u,type:"article",license:"",recordNotes:t,memo:t}}}),S)}catch(t){console.error("error occured when submitting ISCN:"),console.error(t),lcPostInfo.mainStatus="failed"}}():"ARWEAVE_SUBMITTED"===o?async function(t){const{ipfsHash:e,arweaveId:o}=t;if(e&&o){lcPostInfo.arweaveIPFSHash=e,lcPostInfo.arweaveId=o,g(n,m(lcPostInfo.mainStatus));const t={arweaveIPFSHash:e,arweaveId:o};try{await jQuery.ajax({type:"POST",url:`${likecoinApiSettings.root}likecoin/v1/posts/${likecoinApiSettings.postId}/iscn/arweave`,dataType:"json",contentType:"application/json; charset=UTF-8",data:JSON.stringify(t),method:"POST",beforeSend:t=>{t.setRequestHeader("X-WP-Nonce",likecoinApiSettings.nonce)}})}catch(t){console.error(t)}finally{await P()}}}(i):"ISCN_SUBMITTED"===o?async function(t){lcPostInfo.mainStatus="onRegisterISCN";try{const{tx_hash:e,error:n,success:o,iscnId:i}=t;if(n||!1===o)throw new Error("REGISTER_ISCN_SERVER_ERROR");await jQuery.ajax({type:"POST",url:`${likecoinApiSettings.root}likecoin/v1/posts/${likecoinApiSettings.postId}/iscn/metadata`,dataType:"json",contentType:"application/json; charset=UTF-8",data:JSON.stringify({iscnHash:e,iscnId:i}),method:"POST",beforeSend:t=>{t.setRequestHeader("X-WP-Nonce",likecoinApiSettings.nonce)}}),lcPostInfo.iscnHash=e,lcPostInfo.iscnId=i,lcPostInfo.mainStatus="done"}catch(t){console.error(t),lcPostInfo.mainStatus="failed"}finally{await P()}}(i):console.warn(`Unknown event: ${o}`)}catch(t){console.error(t)}}async function y(t){t&&t.preventDefault();const{siteurl:e}=likecoinApiSettings,{url:o}=lcPostInfo;lcPostInfo.mainStatus="onRegisterISCN",g(n,m(lcPostInfo.mainStatus));const i=encodeURIComponent(e),s=encodeURIComponent(lcPostInfo.iscnId||""),a=encodeURIComponent(o),r=`${S}/nft/url?opener=1&platform=wordpress&redirect_uri=${i}&url=${a}&iscn_id=${s}&update=${s?1:0}`,c=window.open(r,"likeCoISCNWindow","menubar=no,location=no,width=576,height=768");if(!c||c.closed||void 0===c.closed)return lcPostInfo.mainStatus="failedPopup",void g(n,m(lcPostInfo.mainStatus));lcPostInfo.ISCNWindow=c,lcPostInfo.mainStatus="initial",window.addEventListener("message",w,!1)}(()=>{const t=document.getElementById("lcPublishRefreshBtn");t&&t.addEventListener("click",P),P()})()}();